---
title: "P3"
author: "Landon Hunsaker"
format: html
embed-resources: true
editor: source
---

```{r, include=FALSE}
#| label: metadata
#| purl: true
# Name: Landon Hunsaker
# Date: 2025-11-17
# Purpose: Portfolio Analysis #2
# -----------------------------------------------------------------------------
```

```{r, include=FALSE}
#| label: Packages Setup
#| purl: true

library(ggplot2)
library(tidyverse)

files <- list.files("data", pattern = "*.csv", full.names = TRUE)
gas <- files |> lapply(read_csv) |> bind_rows()

```

## Introduction:

The vast majority of Americans don't pay attention to type or composition of the fuel they put into there cars. Fuel can vary by refinement, age, and some even have added chemicals. This percentage of chemicals can vary between gasoline, but as a baseline, normal 87 octane gasoline has around [10%.](https://afdc.energy.gov/fuels/ethanol-fuel-basics) Ethanol is used for a variety of reasons, some environmentaland some economic. One important factor, ethanol contains an alcohol group, meaning that theoretically, it could oxygenate the hydrocarbons in the fuel vigorously. This should lead to cleaner burning and more complete combustion. So, how important is ethanol to fuel economy?

## The Data:

To test the above question, I will be analyzing a data set composed of 24 csv's ranging from 2012 all the way to 2025. These csv's contain variations in columns and rows. Before tidying, there were 19 columns, 11 of these columns are redundant and contain the same type of measurements but not coalesced. I used coalesce or a conversion to combine 10 of these. All conversions (currency, distance, ect.), were converted in the manner listed below. The final column was the most challenging. This column, "notes", contained both notes about the car and notes about the station filled. I needed to separate the two and put them into Notes or Station respectively. To accomplish this, I used a string search with the most common gas station names in notes. Then, I did the inverse to move the remainder into Notes.

After tidying this data will contain 8 columns.

date: The date of purchase for the corresponding gasoline.

gallons: The number of gallons purchased. (Note: some of the data was present in liters, this was converted to gallons before analysis).

USD: Total cost in United States Dollars. (CAD were converted at an exhange rate of 1:.72).

Miles: Mileage used before filling up, i.e. the distance covered using the previous gas tank.

ethanol: This contains the ethanol percentage in the fuel.

octane: The octance of the gasoline purchased.

Notes: Any important notes to consider in the fueling process.

Station: The station the car filled up at.

**Important Note:** Some data points had notes on towing trailers and canoes, these will significantly impact the fuel economy. For now, they remain in the data, as they shouldn't make an enormouse impact to our sample means.

```{r,include=FALSE}
#| label: Tidying
#| purl: true

gasc <- gas |> filter(!if_all(everything(), is.na))

gasg <- gasc |>
  mutate(
    gallons = case_when(
      !is.na(Units) & Units == "Liters"  ~ `Amount of fuel` / 3.78541, ### conversion to gal.
      !is.na(Units) & Units == "Gallons" ~ `Amount of fuel`,
      is.na(Units) & !is.na(`Amount of fuel`) ~ `Amount of fuel`,
      TRUE ~ gallons
    ),
    USD = case_when(
      Currency == "USD" ~ Cost,
      Currency == "CAD" ~ Cost *.72, ### Exchange rate as of 12/10/2025
      TRUE ~ USD
  )
  
)

### Moving Station 'notes' to 'Station' to prep 'notes' for deletion.
gasg <- gasg |> mutate(
  Station = case_when( ### String search to identify the common gas stations in notes
    !is.na(Station) ~ Station,
    grepl("costco|sams|swift|holiday|philip|owatonna|BP|conoco|casey|cenex|valero|Exxon|Kum|Quick|Kwik|shell|M&H|loves|arco|Ace|Reata|Flying|Esso", notes,ignore.case=TRUE)~notes,
    TRUE~Station
  )
)

### Moving notes to Notes to prep for deletion
gas_notes_clean <- gasg |> mutate(
  Notes = case_when( 
    !is.na(Notes) ~ Notes,
    !grepl("costco|sams|swift|holiday|philip|owatonna|BP|conoco|casey|cenex|valero|Exxon|Kum|Quick|Kwik|shell|M&H|loves|arco|Ace|Reata|Flying|Esso", notes,ignore.case=TRUE) & !is.na(notes) ~notes,
    TRUE~Notes
  )
)

### Main coalescing and deletion.

intermed <- gas_notes_clean |> mutate(
   USD = case_when(
     !is.na(CAD) ~ CAD*.72, ### Converting the first half of the csv's CAD
     TRUE~USD
   ),
   gallons = coalesce(gallons, liters / 3.78541),
   ethanol = coalesce(ethanol,`Ethanol %`),
   miles = coalesce(miles,Mileage),
   octane = coalesce(octane,Octane),
   Timestamp = as.Date(Timestamp),
   date = coalesce(date, Timestamp), ### Would've been easier to just select the rows I wanted, but too late.
   ) |> select(-liters, -Octane, -`Ethanol %`, -Mileage, -notes, -`Amount of fuel`,  -Units, -Timestamp, -Cost, -Currency, -CAD)

```

## Methods:

Now that the data is organized and ready for analysis, we can look for statistical significance in the different fuel types. To start, I will ensure the data is normal so I can assess viability of a two sample t.test. Given that I can average and find the mean between the two groups, the t.test seems ideal here. Importantly, I will be testing the mpg from the *previous* fill up, as that's the one that was burned. Furthermore, the tanks were not always run empty than refilled. This means that preexisting ethanol or non ethanol fuel would existed in the tank prior to measuring. Given that a 2011 Toyota Sienna can hold 20 gallons, I will eliminate fill ups less than 15 gallons. This should ensure that the majority of fuel being burned was more or less one type of gas.

```{r,include=FALSE}
#| label: More tidying and doing MPG
#| purl: true


int.final <- intermed |> mutate(
  gallons_correct = lag(gallons),
  ethanol_raw= lag(ethanol)
)

final <- int.final |> filter(    
  gallons_correct > 15   ### The tank cannot be mostly full of separate fuel. This is 75%.
) |> mutate(
  ethanol_correct = case_when( ### Combining upper ethanol values for testing + drop nas
    ethanol_raw == 0  ~ "E0",
    ethanol_raw == 10 ~ "E10",
    TRUE ~ NA_character_
  )) |> filter(!is.na(ethanol_correct)) |> select(-ethanol,-ethanol_raw)

mpg <- final |> mutate(
  mpg = case_when(
    !is.na(gallons_correct) & !is.na(miles) ~ miles / gallons_correct, ### removing na's
    TRUE ~ NA_real_
  )
)

table(int.final$ethanol_raw, useNA = "ifany")
```

```{r,echo=FALSE,warning=FALSE,message=FALSE}
#| label: Checking normality
#| purl: true
#| fig-width: 3
#| fig-height: 2
#| layout-ncol: 2

ggplot(data=mpg)+ ### Histogram
  geom_histogram(
    aes(x=mpg),
    color="black",
    fill="gold",
  )+
  labs(
    title= "Frequency of MPG values",
    x= "MPG measured",
    y= "Occurences"
  )+
  theme_bw()

ggplot(data=mpg)+ ### Boxplot
  geom_boxplot(
    mapping=aes(x=ethanol_correct, y= mpg),
    fill="white",
    color="black"
  )+
  labs(
    title= "variances of gas",
    y="Miles per gallon",
    x= "Type of fuel"
  )
```

The histogram plot looks normal. A fantastic bell shape and normal tails. I see nothing that would indicate non-normality.Taking a look at the variances in the box plot, it looks great. E10 fuel has more extreme outliers but nothing to worry about. Both the medians and IQR look identical. With that level of variance, we can run a two sample t.test to check for significant differences between the two groups.

```{r,echo=FALSE}
#| label: T-test
#| purl: true
### By default, two sample welches t-test.
t.test(mpg ~ethanol_correct, data=mpg,var.equal=TRUE)
```

## Results:

Given the lack of extreme variance and apparent normality, a welches t-test was used to test a difference between mean miles per gallon within groups. The average miles per gallon of E0 fuel was 16.11 mpg and in E10 fuel it was 15.518. The results of this t test was a t statistic of 0.70196 on 203 degrees of freedom. The corresponding p value is 0.4835. This large p-value means we fail to reject the null hypothesis of no difference between gas types. The CI for a difference between means was a -1.061604 LB and a 2.235376 UB.

## Disscusion:

This data was messy and complicated. Many choices made in tidying could have impacted the results shared above. For example, I eliminated many rows when I only analyzed gas tanks that were filled with more than 15 gallons. Just doing that I dropped around 80% of the data set. Compounding this, many rows had NA values that caused them to be scrubbed from analysis. Finally, the MPG testing was not accurate. Because we had to test the previous tank of gas, the variation in distance traveled between tanks was great. Sometimes there were 19 gallons of gas burned, but the driver had only filled up 16 gallons the last time. This would make my mpg calculations off.

All that being said, the t test yielded insignificant results. There is no evidence of a difference between the two fuels. To answer our original question, "how important is ethanol to fuel economy?" In this analysis it doesn't make any measurable difference.

If I were in charge of data collection, I would highly encourage the driver to only use one type of gas for an extended period. With cleaner data collection and greater separation of fuels, a more precise test could be administered.
